// All things arithmetic
// JJM 051109

#include "math.h"

// GLOBALS

const int g_nSin_FP_16_16[360]=
{ 0x0000, 0x0477, 0x08EF, 0x0D65, 0x11DB, 0x164F, 0x1AC2, 0x1F32, 0x23A0, 0x280C, 0x2C74, 0x30D8, 0x3539, 0x3996, 0x3DEE, 0x4241, 0x4690,
0x4AD8, 0x4F1B, 0x5358, 0x578E, 0x5BBD, 0x5FE6, 0x6406, 0x681F, 0x6C30, 0x7039, 0x7438, 0x782F, 0x7C1C, 0x7FFF, 0x83D9, 0x87A8,
0x8B6D, 0x8F27, 0x92D5, 0x9679, 0x9A10, 0x9D9B, 0xA11B, 0xA48D, 0xA7F3, 0xAB4C, 0xAE97, 0xB1D5, 0xB504, 0xB826, 0xBB39, 0xBE3E,
0xC134, 0xC41B, 0xC6F3, 0xC9BB, 0xCC73, 0xCF1B, 0xD1B3, 0xD43B, 0xD6B3, 0xD919, 0xDB6F, 0xDDB3, 0xDFE7, 0xE208, 0xE418, 0xE617,
0xE803, 0xE9DE, 0xEBA6, 0xED5B, 0xEEFF, 0xF08F, 0xF20D, 0xF378, 0xF4D0, 0xF615, 0xF746, 0xF865, 0xF970, 0xFA67, 0xFB4B, 0xFC1C,
0xFCD9, 0xFD82, 0xFE17, 0xFE98, 0xFF06, 0xFF60, 0xFFA6, 0xFFD8, 0xFFF6, 0xFFFF, 0xFFF6, 0xFFD8, 0xFFA6, 0xFF60, 0xFF06, 0xFE98,
0xFE17, 0xFD82, 0xFCD9, 0xFC1C, 0xFB4B, 0xFA67, 0xF970, 0xF865, 0xF746, 0xF615, 0xF4D0, 0xF378, 0xF20D, 0xF08F, 0xEEFF, 0xED5B,
0xEBA6, 0xE9DE, 0xE803, 0xE617, 0xE419, 0xE208, 0xDFE7, 0xDDB3, 0xDB6F, 0xD919, 0xD6B3, 0xD43B, 0xD1B4, 0xCF1B, 0xCC73, 0xC9BB,
0xC6F3, 0xC41B, 0xC134, 0xBE3E, 0xBB3A, 0xB826, 0xB505, 0xB1D5, 0xAE97, 0xAB4C, 0xA7F3, 0xA48D, 0xA11B, 0x9D9C, 0x9A10, 0x9679,
0x92D6, 0x8F27, 0x8B6D, 0x87A8, 0x83D9, 0x8000, 0x7C1C, 0x782F, 0x7438, 0x7039, 0x6C30, 0x6820, 0x6407, 0x5FE6, 0x5BBE, 0x578E,
0x5358, 0x4F1B, 0x4AD9, 0x4690, 0x4242, 0x3DEE, 0x3996, 0x3539, 0x30D9, 0x2C74, 0x280C, 0x23A1, 0x1F32, 0x1AC2, 0x1650, 0x11DB,
0x0D66, 0x08EF, 0x0477, 0x0000, 0xFFFFFB89, 0xFFFFF712, 0xFFFFF29B, 0xFFFFEE25, 0xFFFFE9B1, 0xFFFFE53E, 0xFFFFE0CE, 0xFFFFDC60, 0xFFFFD7F5, 0xFFFFD38C, 0xFFFFCF28, 0xFFFFCAC7,
0xFFFFC66A, 0xFFFFC212, 0xFFFFBDBF, 0xFFFFB971, 0xFFFFB528, 0xFFFFB0E5, 0xFFFFACA8, 0xFFFFA872, 0xFFFFA443, 0xFFFFA01A, 0xFFFF9BFA, 0xFFFF97E1, 0xFFFF93D0, 0xFFFF8FC8, 0xFFFF8BC8, 0xFFFF87D1,
0xFFFF83E4, 0xFFFF8001, 0xFFFF7C27, 0xFFFF7858, 0xFFFF7493, 0xFFFF70D9, 0xFFFF6D2B, 0xFFFF6988, 0xFFFF65F0, 0xFFFF6265, 0xFFFF5EE6, 0xFFFF5B73, 0xFFFF580D, 0xFFFF54B5, 0xFFFF5169, 0xFFFF4E2C,
0xFFFF4AFC, 0xFFFF47DA, 0xFFFF44C7, 0xFFFF41C2, 0xFFFF3ECC, 0xFFFF3BE5, 0xFFFF390E, 0xFFFF3646, 0xFFFF338D, 0xFFFF30E5, 0xFFFF2E4D, 0xFFFF2BC5, 0xFFFF294E, 0xFFFF26E7, 0xFFFF2491, 0xFFFF224D,
0xFFFF201A, 0xFFFF1DF8, 0xFFFF1BE8, 0xFFFF19E9, 0xFFFF17FD, 0xFFFF1622, 0xFFFF145A, 0xFFFF12A5, 0xFFFF1101, 0xFFFF0F71, 0xFFFF0DF3, 0xFFFF0C88, 0xFFFF0B30, 0xFFFF09EB, 0xFFFF08BA, 0xFFFF079B,
0xFFFF0690, 0xFFFF0599, 0xFFFF04B5, 0xFFFF03E4, 0xFFFF0327, 0xFFFF027E, 0xFFFF01E9, 0xFFFF0168, 0xFFFF00FA, 0xFFFF00A0, 0xFFFF005A, 0xFFFF0028, 0xFFFF000A, 0xFFFF0001, 0xFFFF000A, 0xFFFF0028,
0xFFFF005A, 0xFFFF00A0, 0xFFFF00FA, 0xFFFF0167, 0xFFFF01E9, 0xFFFF027E, 0xFFFF0327, 0xFFFF03E4, 0xFFFF04B5, 0xFFFF0599, 0xFFFF0690, 0xFFFF079B, 0xFFFF08BA, 0xFFFF09EB, 0xFFFF0B30, 0xFFFF0C88,
0xFFFF0DF3, 0xFFFF0F71, 0xFFFF1101, 0xFFFF12A4, 0xFFFF145A, 0xFFFF1622, 0xFFFF17FD, 0xFFFF19E9, 0xFFFF1BE7, 0xFFFF1DF8, 0xFFFF2019, 0xFFFF224D, 0xFFFF2491, 0xFFFF26E7, 0xFFFF294D, 0xFFFF2BC5,
0xFFFF2E4C, 0xFFFF30E5, 0xFFFF338D, 0xFFFF3645, 0xFFFF390D, 0xFFFF3BE5, 0xFFFF3ECC, 0xFFFF41C2, 0xFFFF44C6, 0xFFFF47DA, 0xFFFF4AFB, 0xFFFF4E2B, 0xFFFF5169, 0xFFFF54B4, 0xFFFF580D, 0xFFFF5B73,
0xFFFF5EE5, 0xFFFF6264, 0xFFFF65F0, 0xFFFF6987, 0xFFFF6D2A, 0xFFFF70D9, 0xFFFF7493, 0xFFFF7857, 0xFFFF7C27, 0xFFFF8000, 0xFFFF83E4, 0xFFFF87D1, 0xFFFF8BC7, 0xFFFF8FC7, 0xFFFF93CF, 0xFFFF97E0,
0xFFFF9BF9, 0xFFFFA01A, 0xFFFFA442, 0xFFFFA872, 0xFFFFACA8, 0xFFFFB0E4, 0xFFFFB527, 0xFFFFB970, 0xFFFFBDBE, 0xFFFFC212, 0xFFFFC66A, 0xFFFFCAC6, 0xFFFFCF27, 0xFFFFD38C, 0xFFFFD7F4, 0xFFFFDC5F,
0xFFFFE0CD, 0xFFFFE53E, 0xFFFFE9B0, 0xFFFFEE25, 0xFFFFF29A, 0xFFFFF711, 0xFFFFFB88,
};

const int g_nCos_FP_16_16[360]=
{   0x10000, 0xFFF6, 0xFFD8, 0xFFA6, 0xFF60, 0xFF06, 0xFE98, 0xFE17, 0xFD82, 0xFCD9, 0xFC1C, 0xFB4B, 0xFA67, 0xF970, 0xF865, 0xF746, 0xF615,
0xF4D0, 0xF378, 0xF20D, 0xF08F, 0xEEFF, 0xED5B, 0xEBA6, 0xE9DE, 0xE803, 0xE617, 0xE419, 0xE208, 0xDFE7, 0xDDB3, 0xDB6F, 0xD919,
0xD6B3, 0xD43B, 0xD1B3, 0xCF1B, 0xCC73, 0xC9BB, 0xC6F3, 0xC41B, 0xC134, 0xBE3E, 0xBB3A, 0xB826, 0xB504, 0xB1D5, 0xAE97, 0xAB4C,
0xA7F3, 0xA48D, 0xA11B, 0x9D9C, 0x9A10, 0x9679, 0x92D5, 0x8F27, 0x8B6D, 0x87A8, 0x83D9, 0x8000, 0x7C1C, 0x782F, 0x7438, 0x7039,
0x6C30, 0x681F, 0x6407, 0x5FE6, 0x5BBE, 0x578E, 0x5358, 0x4F1B, 0x4AD8, 0x4690, 0x4242, 0x3DEE, 0x3996, 0x3539, 0x30D8, 0x2C74,
0x280C, 0x23A0, 0x1F32, 0x1AC2, 0x164F, 0x11DB, 0x0D65, 0x08EF, 0x0477, 0x0000, 0xFFFFFB89, 0xFFFFF711, 0xFFFFF29B, 0xFFFFEE25, 0xFFFFE9B1, 0xFFFFE53E,
0xFFFFE0CE, 0xFFFFDC60, 0xFFFFD7F5, 0xFFFFD38C, 0xFFFFCF28, 0xFFFFCAC7, 0xFFFFC66A, 0xFFFFC212, 0xFFFFBDBF, 0xFFFFB970, 0xFFFFB528, 0xFFFFB0E5, 0xFFFFACA8, 0xFFFFA872, 0xFFFFA443, 0xFFFFA01A,
0xFFFF9BFA, 0xFFFF97E1, 0xFFFF93D0, 0xFFFF8FC8, 0xFFFF8BC8, 0xFFFF87D1, 0xFFFF83E4, 0xFFFF8001, 0xFFFF7C27, 0xFFFF7858, 0xFFFF7493, 0xFFFF70D9, 0xFFFF6D2B, 0xFFFF6988, 0xFFFF65F0, 0xFFFF6265,
0xFFFF5EE5, 0xFFFF5B73, 0xFFFF580D, 0xFFFF54B4, 0xFFFF5169, 0xFFFF4E2B, 0xFFFF4AFC, 0xFFFF47DA, 0xFFFF44C7, 0xFFFF41C2, 0xFFFF3ECC, 0xFFFF3BE5, 0xFFFF390E, 0xFFFF3646, 0xFFFF338D, 0xFFFF30E5,
0xFFFF2E4D, 0xFFFF2BC5, 0xFFFF294D, 0xFFFF26E7, 0xFFFF2491, 0xFFFF224D, 0xFFFF2019, 0xFFFF1DF8, 0xFFFF1BE8, 0xFFFF19E9, 0xFFFF17FD, 0xFFFF1622, 0xFFFF145A, 0xFFFF12A5, 0xFFFF1101, 0xFFFF0F71,
0xFFFF0DF3, 0xFFFF0C88, 0xFFFF0B30, 0xFFFF09EB, 0xFFFF08BA, 0xFFFF079B, 0xFFFF0690, 0xFFFF0599, 0xFFFF04B5, 0xFFFF03E4, 0xFFFF0327, 0xFFFF027E, 0xFFFF01E9, 0xFFFF0168, 0xFFFF00FA, 0xFFFF00A0,
0xFFFF005A, 0xFFFF0028, 0xFFFF000A, 0xFFFF0001, 0xFFFF000A, 0xFFFF0028, 0xFFFF005A, 0xFFFF00A0, 0xFFFF00FA, 0xFFFF0167, 0xFFFF01E9, 0xFFFF027E, 0xFFFF0327, 0xFFFF03E4, 0xFFFF04B5, 0xFFFF0599,
0xFFFF0690, 0xFFFF079B, 0xFFFF08BA, 0xFFFF09EB, 0xFFFF0B30, 0xFFFF0C88, 0xFFFF0DF3, 0xFFFF0F71, 0xFFFF1101, 0xFFFF12A5, 0xFFFF145A, 0xFFFF1622, 0xFFFF17FD, 0xFFFF19E9, 0xFFFF1BE7, 0xFFFF1DF8,
0xFFFF2019, 0xFFFF224D, 0xFFFF2491, 0xFFFF26E7, 0xFFFF294D, 0xFFFF2BC5, 0xFFFF2E4C, 0xFFFF30E5, 0xFFFF338D, 0xFFFF3645, 0xFFFF390D, 0xFFFF3BE5, 0xFFFF3ECC, 0xFFFF41C2, 0xFFFF44C6, 0xFFFF47DA,
0xFFFF4AFB, 0xFFFF4E2B, 0xFFFF5169, 0xFFFF54B4, 0xFFFF580D, 0xFFFF5B73, 0xFFFF5EE5, 0xFFFF6264, 0xFFFF65F0, 0xFFFF6987, 0xFFFF6D2A, 0xFFFF70D9, 0xFFFF7493, 0xFFFF7858, 0xFFFF7C27, 0xFFFF8000,
0xFFFF83E4, 0xFFFF87D1, 0xFFFF8BC8, 0xFFFF8FC7, 0xFFFF93D0, 0xFFFF97E0, 0xFFFF9BF9, 0xFFFFA01A, 0xFFFFA442, 0xFFFFA872, 0xFFFFACA8, 0xFFFFB0E5, 0xFFFFB527, 0xFFFFB970, 0xFFFFBDBE, 0xFFFFC212,
0xFFFFC66A, 0xFFFFCAC7, 0xFFFFCF27, 0xFFFFD38C, 0xFFFFD7F4, 0xFFFFDC5F, 0xFFFFE0CD, 0xFFFFE53E, 0xFFFFE9B0, 0xFFFFEE25, 0xFFFFF29A, 0xFFFFF711, 0xFFFFFB88, 0x0000, 0x0477, 0x08EE,
0x0D65, 0x11DB, 0x164F, 0x1AC2, 0x1F32, 0x23A0, 0x280B, 0x2C73, 0x30D8, 0x3539, 0x3996, 0x3DEE, 0x4241, 0x468F, 0x4AD8, 0x4F1B,
0x5358, 0x578E, 0x5BBD, 0x5FE5, 0x6406, 0x681F, 0x6C30, 0x7038, 0x7438, 0x782F, 0x7C1C, 0x7FFF, 0x83D9, 0x87A8, 0x8B6D, 0x8F27,
0x92D5, 0x9678, 0x9A10, 0x9D9B, 0xA11A, 0xA48D, 0xA7F3, 0xAB4B, 0xAE97, 0xB1D4, 0xB504, 0xB826, 0xBB39, 0xBE3E, 0xC134, 0xC41B,
0xC6F2, 0xC9BA, 0xCC73, 0xCF1B, 0xD1B3, 0xD43B, 0xD6B2, 0xD919, 0xDB6F, 0xDDB3, 0xDFE6, 0xE208, 0xE418, 0xE617, 0xE803, 0xE9DD,
0xEBA6, 0xED5B, 0xEEFF, 0xF08F, 0xF20D, 0xF378, 0xF4D0, 0xF615, 0xF746, 0xF865, 0xF970, 0xFA67, 0xFB4B, 0xFC1C, 0xFCD9, 0xFD82,
0xFE17, 0xFE98, 0xFF06, 0xFF60, 0xFFA6, 0xFFD8, 0xFFF6,
};

// IMPLEMENTATION

void Math_M2Mult(M2* pResult, const M2* Left, const M2* Right)
{
    pResult->nX1 = Left->nX1 * Right->nX1 + Left->nY1 * Right->nX2 + Left->nW1 * Right->nX3;
    pResult->nY1 = Left->nX1 * Right->nY1 + Left->nY1 * Right->nY2 + Left->nW1 * Right->nY3;
    pResult->nW1 = Left->nX1 * Right->nW1 + Left->nY1 * Right->nW2 + Left->nW1 * Right->nW3;
    pResult->nX2 = Left->nX2 * Right->nX1 + Left->nY2 * Right->nX2 + Left->nW2 * Right->nX3;
    pResult->nY2 = Left->nX2 * Right->nY1 + Left->nY2 * Right->nY2 + Left->nW2 * Right->nY3;
    pResult->nW2 = Left->nX2 * Right->nW1 + Left->nY2 * Right->nW2 + Left->nW2 * Right->nW3;
    pResult->nX3 = Left->nX3 * Right->nX1 + Left->nY3 * Right->nX2 + Left->nW3 * Right->nX3;
    pResult->nY3 = Left->nX3 * Right->nY1 + Left->nY3 * Right->nY2 + Left->nW3 * Right->nY3;
    pResult->nW3 = Left->nX3 * Right->nW1 + Left->nY3 * Right->nW2 + Left->nW3 * Right->nW3;
}

void Math_M2_FP_BitShift(M2* pMatrix, int nBitShift)
{
    if(nBitShift >= 0)
    {
        pMatrix->nX1 <<= nBitShift; pMatrix->nY1 <<= nBitShift; pMatrix->nW1 <<= nBitShift;
        pMatrix->nX2 <<= nBitShift; pMatrix->nY2 <<= nBitShift; pMatrix->nW2 <<= nBitShift;
        pMatrix->nX3 <<= nBitShift; pMatrix->nY3 <<= nBitShift; pMatrix->nW3 <<= nBitShift;
    }
    else
    {
        pMatrix->nX1 >>= -nBitShift; pMatrix->nY1 >>= -nBitShift; pMatrix->nW1 >>= -nBitShift;
        pMatrix->nX2 >>= -nBitShift; pMatrix->nY2 >>= -nBitShift; pMatrix->nW2 >>= -nBitShift;
        pMatrix->nX3 >>= -nBitShift; pMatrix->nY3 >>= -nBitShift; pMatrix->nW3 >>= -nBitShift;
    }
}